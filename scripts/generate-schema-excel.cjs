const XLSX = require('xlsx');
const path = require('path');

// 데이터 스키마 정의
const schemas = {
  // Sheet 1: ETF 마스터 데이터
  'ETF_마스터': [
    ['필드명', '영문명', '타입', '필수여부', '설명', '예시값', '비고'],
    ['ETF ID', 'id', 'string', 'Y', 'ETF 고유 식별자', '1', 'Primary Key'],
    ['종목코드', 'ticker', 'string', 'Y', '거래소 종목코드 (6자리)', '069500', 'KRX 표준'],
    ['정식명칭', 'name', 'string', 'Y', 'ETF 정식 상품명', 'KODEX 200', ''],
    ['단축명', 'shortName', 'string', 'Y', '화면 표시용 단축명', 'KODEX 200', ''],
    ['현재가', 'price', 'number', 'Y', '현재 거래 가격 (원)', '35420', '실시간 업데이트'],
    ['전일종가', 'prevClose', 'number', 'Y', '전일 종가 (원)', '35200', ''],
    ['등락폭', 'change', 'number', 'Y', '전일 대비 등락 금액 (원)', '220', '양수=상승, 음수=하락'],
    ['등락률', 'changePercent', 'number', 'Y', '전일 대비 등락률 (%)', '0.63', '소수점 2자리'],
    ['추정순자산가치', 'iNav', 'number', 'Y', 'iNAV (원)', '35415', '실시간 계산값'],
    ['괴리율', 'discrepancy', 'number', 'Y', '(현재가-iNAV)/iNAV × 100 (%)', '0.01', '소수점 2자리'],
    ['총보수율', 'ter', 'number', 'Y', 'Total Expense Ratio (%)', '0.05', '연간 비용'],
    ['스프레드', 'spread', 'number', 'Y', '매수/매도 호가 차이 (%)', '0.02', '유동성 지표'],
    ['평균거래대금', 'adtv', 'number', 'Y', 'Average Daily Trading Value (원)', '892000000000', '일평균'],
    ['순자산총액', 'aum', 'number', 'Y', 'Assets Under Management (원)', '5200000000000', ''],
    ['추적오차', 'trackingError', 'number', 'Y', '지수 대비 추적오차 (%)', '0.03', ''],
    ['변동성', 'volatility', 'number', 'Y', '가격 변동성 (%)', '12.5', '연환산'],
    ['배당수익률', 'dividendYield', 'number', 'Y', '연간 배당수익률 (%)', '1.8', ''],
    ['카테고리', 'category', 'string', 'Y', '상품 카테고리', '시장대표', '시장대표/글로벌/배당 등'],
    ['태그', 'tags', 'string[]', 'Y', '검색/필터용 태그 배열', '["국내", "KOSPI200"]', 'JSON 배열'],
    ['건전성점수', 'healthScore', 'number', 'Y', '종합 건전성 점수 (0-100)', '98', '자체 계산'],
    ['레버리지여부', 'isLeveraged', 'boolean', 'N', '레버리지 상품 여부', 'false', '기본값: false'],
    ['인버스여부', 'isInverse', 'boolean', 'N', '인버스 상품 여부', 'false', '기본값: false'],
    ['환헤지여부', 'isHedged', 'boolean', 'N', '환헤지 적용 여부', 'false', '기본값: false'],
    ['스파크라인', 'sparkline', 'number[]', 'Y', '최근 7일 가격 데이터', '[35100, 35200, ...]', '차트 표시용'],
    ['상품개요', 'overview', 'string', 'Y', '상품 설명', 'KOSPI200 지수를 추종...', ''],
    ['지수설명', 'indexDescription', 'string', 'Y', '추종 지수 설명', 'KOSPI200: 유가증권시장...', ''],
    ['운용전략', 'strategy', 'string', 'Y', '운용 전략 설명', '시가총액 가중 방식의 패시브 운용', ''],
    ['운용사', 'issuer', 'string', 'Y', '자산운용사명', '삼성자산운용', ''],
    ['상장일', 'listedDate', 'string', 'Y', '최초 상장일', '2002/10/14', 'YYYY/MM/DD'],
    ['지수제공자', 'indexProvider', 'string', 'Y', '기초지수 산출기관', 'KRX', ''],
    ['자산군', 'assetClass', 'string', 'Y', '자산 분류', '주식', '주식/채권/원자재/통화'],
    ['시장구분', 'marketClass', 'string', 'Y', '투자 시장', '국내', '국내/해외'],
  ],

  // Sheet 2: 포트폴리오 데이터
  '포트폴리오_보유': [
    ['필드명', '영문명', '타입', '필수여부', '설명', '예시값', '비고'],
    ['ETF ID', 'id', 'string', 'Y', 'ETF 마스터 참조 ID', '1', 'FK → ETF.id'],
    ['종목코드', 'ticker', 'string', 'Y', '거래소 종목코드', '069500', ''],
    ['단축명', 'shortName', 'string', 'Y', 'ETF 단축명', 'KODEX 200', ''],
    ['현재가', 'price', 'number', 'Y', '현재 거래가격 (원)', '35420', ''],
    ['보유수량', 'quantity', 'number', 'Y', '보유 주식 수', '100', ''],
    ['평균매입단가', 'avgPrice', 'number', 'Y', '평균 매입 가격 (원)', '34500', ''],
    ['평가금액', 'totalValue', 'number', 'Y', '현재가 × 보유수량 (원)', '3542000', ''],
    ['매입금액', 'totalCost', 'number', 'Y', '평균단가 × 보유수량 (원)', '3450000', '계산 필드'],
    ['손익금액', 'profitLoss', 'number', 'Y', '평가금액 - 매입금액 (원)', '92000', ''],
    ['손익률', 'profitLossPercent', 'number', 'Y', '손익금액 / 매입금액 × 100 (%)', '2.67', ''],
    ['건전성점수', 'healthScore', 'number', 'Y', 'ETF 건전성 점수', '98', ''],
    ['괴리율', 'discrepancy', 'number', 'Y', '현재 괴리율 (%)', '0.01', ''],
    ['스프레드', 'spread', 'number', 'Y', '현재 스프레드 (%)', '0.02', ''],
    ['자산군', 'assetClass', 'string', 'Y', '자산 분류', '주식', '자산배분 계산용'],
  ],

  // Sheet 3: 분배금 일정
  '분배금_일정': [
    ['필드명', '영문명', '타입', '필수여부', '설명', '예시값', '비고'],
    ['ETF ID', 'etfId', 'string', 'Y', 'ETF 마스터 참조 ID', '16', 'FK → ETF.id'],
    ['지급일', 'date', 'string', 'Y', '분배금 지급 예정일', '2026-01-16', 'YYYY-MM-DD'],
    ['주당분배금', 'dividendPerShare', 'number', 'Y', '주당 분배금 (원)', '120', ''],
    ['배당락일', 'exDividendDate', 'string', 'Y', '배당락일', '2026-01-14', 'YYYY-MM-DD'],
  ],

  // Sheet 4: 테마/카테고리
  '테마_카테고리': [
    ['필드명', '영문명', '타입', '필수여부', '설명', '예시값', '비고'],
    ['테마 ID', 'id', 'string', 'Y', '테마 고유 식별자', 'index', ''],
    ['테마명', 'name', 'string', 'Y', '테마 표시명', '시장지수', ''],
    ['아이콘', 'icon', 'string', 'Y', 'Lucide 아이콘명', 'TrendingUp', 'lucide-react'],
  ],

  // Sheet 5: 계좌 타입
  '계좌_타입': [
    ['필드명', '영문명', '타입', '필수여부', '설명', '예시값', '비고'],
    ['계좌 ID', 'id', 'string', 'Y', '계좌 고유 ID', 'general-1', ''],
    ['계좌번호', 'number', 'string', 'Y', '계좌번호', '8012-1234-5678', '마스킹 적용'],
    ['계좌유형', 'type', 'string', 'Y', '계좌 종류 코드', 'general', 'general/pension/isa'],
    ['계좌명', 'label', 'string', 'Y', '계좌 표시명', '일반', ''],
    ['세율', 'taxRate', 'number', 'Y', '적용 세율 (%)', '15.4', '일반:15.4/ISA:9.9/연금:5.5'],
  ],

  // Sheet 6: 투자정보 콘텐츠
  '투자정보_콘텐츠': [
    ['필드명', '영문명', '타입', '필수여부', '설명', '예시값', '비고'],
    ['콘텐츠 ID', 'id', 'string', 'Y', '콘텐츠 고유 ID', 'what-is-etf', ''],
    ['카테고리', 'category', 'string', 'Y', '콘텐츠 분류', 'basic', 'basic/account/strategy/tax/glossary'],
    ['제목', 'title', 'string', 'Y', '콘텐츠 제목', 'ETF 기초', ''],
    ['질문', 'question', 'string', 'Y', '핵심 질문', 'ETF가 뭔가요?', ''],
    ['결론', 'conclusion', 'string', 'Y', '결론 유형', 'yes', 'yes/no/depends'],
    ['요약', 'summary', 'string[]', 'Y', '핵심 요약 (배열)', '["요약1", "요약2"]', '3개 권장'],
    ['본문', 'body', 'string', 'Y', '상세 본문 내용', '...', 'Markdown 지원'],
    ['오해이유', 'misunderstandingReason', 'string', 'N', '흔한 오해 설명', '...', '선택사항'],
    ['출처', 'sources', 'object[]', 'Y', '참고 자료 링크', '[{name, url}]', ''],
    ['관련콘텐츠', 'relatedContents', 'string[]', 'N', '관련 콘텐츠 ID 배열', '["id1", "id2"]', ''],
    ['태그', 'tags', 'string[]', 'Y', '검색용 태그', '["ETF", "기초"]', ''],
    ['조회수', 'viewCount', 'number', 'Y', '조회수', '1500', ''],
    ['도움됨수', 'helpfulCount', 'number', 'Y', '도움됨 클릭 수', '320', ''],
    ['생성일', 'createdAt', 'string', 'Y', '생성일시', '2025-01-01', 'YYYY-MM-DD'],
    ['수정일', 'updatedAt', 'string', 'Y', '최종수정일시', '2025-01-15', 'YYYY-MM-DD'],
    ['법적고지', 'legalDisclaimer', 'string', 'Y', '법적 고지 문구', '...', '필수'],
    ['우선순위', 'priority', 'number', 'Y', '표시 우선순위', '1', '1이 가장 높음'],
  ],

  // Sheet 7: 시장 지수
  '시장_지수': [
    ['필드명', '영문명', '타입', '필수여부', '설명', '예시값', '비고'],
    ['지수 ID', 'id', 'string', 'Y', '지수 고유 ID', 'kospi', ''],
    ['지수명', 'name', 'string', 'Y', '지수 표시명', 'KOSPI', ''],
    ['현재값', 'value', 'number', 'Y', '현재 지수값', '2650.12', ''],
    ['등락폭', 'change', 'number', 'Y', '전일 대비 등락', '15.23', ''],
    ['등락률', 'changePercent', 'number', 'Y', '전일 대비 등락률 (%)', '0.58', ''],
  ],

  // Sheet 8: 히트맵 테마
  '히트맵_테마': [
    ['필드명', '영문명', '타입', '필수여부', '설명', '예시값', '비고'],
    ['테마명', 'theme', 'string', 'Y', '테마/섹터명', 'AI/반도체', ''],
    ['주간수익률', 'weeklyReturn', 'number', 'Y', '주간 수익률 (%)', '3.5', '양수=상승(빨강), 음수=하락(파랑)'],
    ['키워드', 'keywords', 'string[]', 'Y', '테마 분류 키워드', '["AI", "반도체", "HBM"]', 'ETF 매칭용'],
  ],

  // Sheet 9: 코드 정의
  '코드_정의': [
    ['코드유형', '코드값', '코드명', '설명'],
    ['계좌타입', 'general', '일반계좌', '일반 위탁계좌 (세율 15.4%)'],
    ['계좌타입', 'pension', '연금계좌', '개인연금/퇴직연금 (세율 5.5%, 세금이연)'],
    ['계좌타입', 'isa', 'ISA계좌', '개인종합자산관리계좌 (세율 9.9%, 비과세한도 200만원)'],
    ['', '', '', ''],
    ['자산군', '주식', '주식형', '주식에 투자하는 ETF'],
    ['자산군', '채권', '채권형', '채권에 투자하는 ETF'],
    ['자산군', '원자재', '원자재형', '금, 은, 원유 등 원자재 ETF'],
    ['자산군', '통화', '통화형', '달러, 엔화 등 통화 ETF'],
    ['자산군', '혼합', '혼합형', '복수 자산군에 투자하는 ETF'],
    ['', '', '', ''],
    ['시장구분', '국내', '국내시장', '한국 거래소 상장 국내자산 ETF'],
    ['시장구분', '해외', '해외시장', '해외 자산에 투자하는 ETF'],
    ['', '', '', ''],
    ['콘텐츠카테고리', 'basic', '기초 개념', 'ETF 기본 개념 설명'],
    ['콘텐츠카테고리', 'account', '계좌/투자방식', '계좌 유형별 특징'],
    ['콘텐츠카테고리', 'strategy', '투자 전략', '투자 전략 관련 콘텐츠'],
    ['콘텐츠카테고리', 'tax', '세금/배당', '세금 및 배당 관련'],
    ['콘텐츠카테고리', 'glossary', '용어사전', 'ETF 전문용어 설명'],
    ['', '', '', ''],
    ['테마코드', 'index', '시장지수', 'KOSPI, S&P500 등 시장 대표 지수'],
    ['테마코드', 'bond', '채권', '국채, 회사채 등 채권 ETF'],
    ['테마코드', 'dividend', '배당', '배당주, 배당성장 ETF'],
    ['테마코드', 'strategy', '전략', '테마/섹터/액티브 ETF'],
    ['테마코드', 'currency', '통화', '달러, 엔화 등 통화 ETF'],
    ['테마코드', 'commodity', '원자재', '금, 은, 원유 등 원자재 ETF'],
    ['테마코드', 'leverage', '레버리지', '레버리지/인버스 ETF'],
  ],

  // Sheet 10: ETF 태그 정의
  'ETF_태그_정의': [
    ['태그분류', '태그값', '설명', '예시 ETF'],
    ['', '', '', ''],
    ['[시장/지역]', '', '투자 대상 시장 또는 지역', ''],
    ['시장/지역', '국내', '한국 시장 투자', 'KODEX 200, TIGER 200'],
    ['시장/지역', '미국', '미국 시장 투자', 'TIGER 미국S&P500, KODEX 미국나스닥100'],
    ['시장/지역', '해외', '해외 시장 투자 (미국 외)', 'TIGER 글로벌원자력'],
    ['시장/지역', '선진국', '선진국 시장 투자', 'TIGER 미국S&P500'],
    ['', '', '', ''],
    ['[지수]', '', '추종하는 기초 지수', ''],
    ['지수', 'KOSPI200', 'KOSPI200 지수 추종', 'KODEX 200, TIGER 200'],
    ['지수', 'S&P500', 'S&P500 지수 추종', 'TIGER 미국S&P500'],
    ['지수', '나스닥', 'NASDAQ100 지수 추종', 'TIGER 미국나스닥100'],
    ['지수', '다우존스', '다우존스 지수 추종', 'TIGER 미국배당다우존스'],
    ['지수', '코스닥', 'KOSDAQ 지수 추종', 'KODEX 코스닥150'],
    ['지수', 'KRX300', 'KRX300 지수 추종', 'KODEX KRX300'],
    ['지수', 'MSCI', 'MSCI Korea 지수 추종', 'TIGER MSCI Korea TR'],
    ['', '', '', ''],
    ['[종목 유형]', '', '투자 대상 종목 특성', ''],
    ['종목유형', '대형주', '시가총액 상위 대형주', 'KODEX 200'],
    ['종목유형', '중소형', '중소형주 위주', 'KODEX 코스닥150'],
    ['종목유형', '가치주', '가치주 중심 투자', 'RISE 고배당'],
    ['종목유형', '성장주', '성장주 중심 투자', 'KODEX 2차전지산업'],
    ['종목유형', '기술주', '기술/IT 섹터 중심', 'TIGER 미국나스닥100'],
    ['종목유형', '빅테크', '대형 기술주 집중', 'TIGER 미국테크TOP10'],
    ['', '', '', ''],
    ['[테마/섹터]', '', '투자 테마 또는 섹터', ''],
    ['테마', 'AI', '인공지능 관련', 'KODEX AI반도체핵심장비'],
    ['테마', '반도체', '반도체 산업', 'TIGER 반도체'],
    ['테마', '2차전지', '2차전지/배터리', 'KODEX 2차전지산업'],
    ['테마', '게임', '게임/엔터테인먼트', 'TIGER 게임'],
    ['테마', '로봇', '로봇/자동화', 'KODEX K-로봇액티브'],
    ['테마', '원자력', '원자력/SMR', 'TIGER 글로벌원자력'],
    ['테마', '리츠', '부동산/리츠', 'TIGER 리츠부동산인프라'],
    ['테마', 'K콘텐츠', '한국 콘텐츠/미디어', 'TIGER 게임'],
    ['', '', '', ''],
    ['[배당]', '', '배당 관련 특성', ''],
    ['배당', '배당', '배당 중심 투자', 'ACE 미국배당다우존스'],
    ['배당', '고배당', '고배당주 투자', 'RISE 고배당'],
    ['배당', '배당귀족', '배당귀족주 투자', 'TIGER 미국S&P500배당귀족'],
    ['', '', '', ''],
    ['[원자재]', '', '원자재 투자 대상', ''],
    ['원자재', '금', '금/골드 투자', 'KODEX 골드선물(H)'],
    ['원자재', '원유', '원유/WTI 투자', 'KODEX WTI원유선물(H)'],
    ['원자재', 'WTI', 'WTI 원유선물', 'KODEX WTI원유선물(H)'],
    ['원자재', '원자재', '원자재 일반', 'ACE 금현물'],
    ['원자재', '인플레헤지', '인플레이션 헤지용', 'ACE 금현물'],
    ['', '', '', ''],
    ['[통화]', '', '통화 관련', ''],
    ['통화', '달러', '미국 달러', 'KODEX 미국달러선물'],
    ['통화', '환율', '환율 투자', 'KODEX 미국달러선물'],
    ['', '', '', ''],
    ['[채권]', '', '채권 유형', ''],
    ['채권', '국채', '국채 투자', 'TIGER 국채3년'],
    ['채권', '단기채', '단기 채권', 'KODEX 단기채권PLUS'],
    ['채권', 'CD금리', 'CD금리 연동', 'TIGER CD금리투자KIS(합성)'],
    ['채권', 'MMF', '머니마켓펀드', 'TIGER 머니마켓액티브'],
    ['채권', '초단기', '초단기 채권', 'TIGER 머니마켓액티브'],
    ['채권', '안전자산', '안전자산 성격', 'KODEX 단기채권PLUS'],
    ['', '', '', ''],
    ['[운용방식]', '', 'ETF 운용 방식', ''],
    ['운용', 'TR', 'Total Return (배당재투자)', 'KODEX 미국S&P500TR'],
    ['운용', '패시브', '패시브 운용', '1Q K소버린AI'],
    ['운용', '액티브', '액티브 운용', 'TIGER 단기채권액티브'],
    ['운용', 'TOP10', '상위 10종목 집중', 'TIGER 미국테크TOP10'],
    ['운용', 'TOP5', '상위 5종목 집중', 'TIGER TOP5플러스TR'],
    ['', '', '', ''],
    ['[레버리지/인버스]', '', '레버리지/인버스 여부', ''],
    ['레버리지', '2배', '2배 레버리지', 'KODEX 레버리지'],
    ['인버스', '인버스', '인버스 (-1배)', 'KODEX 인버스'],
    ['인버스', '인버스2X', '인버스 2배 (-2배)', 'KODEX 200선물인버스2X'],
    ['', '', '', ''],
    ['[환헤지]', '', '환헤지 여부', ''],
    ['환헤지', '환헤지', '환헤지 적용', 'KODEX 미국S&P500(H)'],
  ],

  // Sheet 10: API 엔드포인트 (향후 개발용)
  'API_명세': [
    ['엔드포인트', '메서드', '설명', '요청파라미터', '응답형식'],
    ['/api/etfs', 'GET', 'ETF 목록 조회', 'page, limit, category, search', 'ETF[]'],
    ['/api/etfs/:id', 'GET', 'ETF 상세 조회', 'id', 'ETF'],
    ['/api/portfolio', 'GET', '포트폴리오 조회', 'accountType', 'PortfolioETF[]'],
    ['/api/portfolio/summary', 'GET', '포트폴리오 요약', 'accountType', '{totalValue, profitLoss, ...}'],
    ['/api/dividends', 'GET', '분배금 일정 조회', 'startDate, endDate', 'DividendSchedule[]'],
    ['/api/dividends/:date', 'GET', '특정일 분배금 조회', 'date (YYYY-MM-DD)', 'DividendSchedule[]'],
    ['/api/market', 'GET', '시장 지수 조회', '', 'MarketIndex[]'],
    ['/api/heatmap', 'GET', '테마 히트맵 조회', '', 'ThemeHeatmap[]'],
    ['/api/contents', 'GET', '투자정보 목록', 'category, search', 'InvestContent[]'],
    ['/api/contents/:id', 'GET', '투자정보 상세', 'id', 'InvestContent'],
  ],
};

// 워크북 생성
const wb = XLSX.utils.book_new();

// 각 시트 추가
Object.entries(schemas).forEach(([sheetName, data]) => {
  const ws = XLSX.utils.aoa_to_sheet(data);

  // 컬럼 너비 설정
  const colWidths = data[0].map((_, colIndex) => {
    const maxLength = Math.max(...data.map(row =>
      String(row[colIndex] || '').length
    ));
    return { wch: Math.min(Math.max(maxLength + 2, 10), 50) };
  });
  ws['!cols'] = colWidths;

  XLSX.utils.book_append_sheet(wb, ws, sheetName);
});

// 파일 저장
const outputPath = path.join(__dirname, '..', 'docs', 'ETF_MTS_데이터스키마_명세서.xlsx');
XLSX.writeFile(wb, outputPath);

console.log(`Excel 파일이 생성되었습니다: ${outputPath}`);
